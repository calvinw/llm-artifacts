<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenRouter API With Artifacts Window</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Add KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <!-- Add KaTeX JS -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <!-- Add auto-render extension for KaTeX -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="panel" id="panel1">
            <div class="panel-header">Settings</div>
            <div class="panel-content">
                <div id="settingsForm" class="settings-form">
                    <div class="settings-group">
                        <label for="apiKey" class="settings-label">API Key:</label>
                        <input type="password" id="apiKey" class="settings-input" placeholder="Enter your API key">
                    </div>
                    <div class="settings-group">
                        <label for="model" class="settings-label">Model:</label>
                        <input type="text" id="model" class="settings-input" placeholder="Enter model name">
                    </div>
                    <div class="settings-group">
                        <label class="settings-label">Render Mode:</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="renderMode" value="text" checked> Text
                            </label>
                            <label>
                                <input type="radio" name="renderMode" value="markdown"> Markdown
                            </label>
                        </div>
                    </div>
                </div>
                <div id="settingsError" class="error-message"></div>
            </div>
        </div>
        <div class="divider" id="divider1"></div>
        <div class="panel" id="panel2">
            <div class="panel-header">
                Chat
                <button id="clearChatButton" class="clear-chat-button">Clear Chat Messages</button>
            </div>
            <div class="system-prompt-container">
                <label for="systemPrompt" class="system-prompt-label">System Prompt:</label>
                <textarea id="systemPrompt" class="system-prompt" placeholder="Enter optional system prompt here"></textarea>
            </div>
            <div class="chat-container" id="chatContainer"></div>
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea id="chatInput" class="chat-input" placeholder="Send a message" rows="3"></textarea>
                    <button id="chatButton" class="chat-button">&#x2798;</button>
                </div>
            </div>
        </div>
        <div class="divider" id="divider2"></div>
        <div class="panel" id="panel3">
            <div class="panel-header">Content</div>
            <div class="panel-content">
                <div class="content-item">
                    <h3>Article Title</h3>
                    <p>This is a sample article content. It can contain various HTML elements like paragraphs, lists, and more.</p>
                </div>
                <div class="content-item">
                    <h3>Another Section</h3>
                    <ul>
                        <li>List item 1</li>
                        <li>List item 2</li>
                        <li>List item 3</li>
                    </ul>
                </div>
                <p> 
                Latex Tests
                </p>
                <div> 
                    <p> Single Dollars </p>
                    $x=4$
                </div>
                <div> 
                    <p> Double Dollars </p>
                    $$x=4$$
                </div>
                <div class="content-item">
                    <h3>Final Thoughts</h3>
                    <p>This panel can be used to display additional information, articles, or any other content relevant to the chat conversation.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let isDragging = false;
            let startX, startWidth1, startWidth2, divider;

            document.querySelectorAll('.divider').forEach(div => {
                div.addEventListener('mousedown', function(e) {
                    isDragging = true;
                    divider = e.target;
                    startX = e.clientX;
                    
                    const prevPanel = divider.previousElementSibling;
                    const nextPanel = divider.nextElementSibling;

                    startWidth1 = prevPanel.offsetWidth;
                    startWidth2 = nextPanel.offsetWidth;

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            });

            function onMouseMove(e) {
                if (!isDragging) return;

                const dx = e.clientX - startX;
                const prevPanel = divider.previousElementSibling;
                const nextPanel = divider.nextElementSibling;

                const newWidth1 = startWidth1 + dx;
                const newWidth2 = startWidth2 - dx;

                if (newWidth1 > 50 && newWidth2 > 50) {
                    prevPanel.style.width = `${newWidth1}px`;
                    nextPanel.style.width = `${newWidth2}px`;
                }
            }

            function onMouseUp() {
                isDragging = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }

            const chatContainer = document.getElementById('chatContainer');
            const chatInput = document.getElementById('chatInput');
            const chatButton = document.getElementById('chatButton');
            const apiKeyInput = document.getElementById('apiKey');
            const modelInput = document.getElementById('model');
            const settingsError = document.getElementById('settingsError');
            const renderModeRadios = document.querySelectorAll('input[name="renderMode"]');
            const clearChatButton = document.getElementById('clearChatButton');
            const systemPromptInput = document.getElementById('systemPrompt');

            let messageHistory = [];

            // Set default values
            let apiKey = '';
            let model = 'google/gemini-flash-1.5-8b';
            let renderMode = 'markdown';
            
            // Initialize input fields with default values
            if (apiKeyInput) {
                apiKeyInput.value = apiKey;
            }
            if (modelInput) {
                modelInput.value = model;
            }

            apiKeyInput?.addEventListener('input', function() {
                apiKey = this.value.trim();
            });

            modelInput?.addEventListener('input', function() {
                model = this.value.trim();
            });

            renderModeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    renderMode = this.value;
                    rerenderMessages();
                });
            });

            chatButton.addEventListener('click', sendMessage);

            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            clearChatButton.addEventListener('click', clearChatMessages);

            function clearChatMessages() {
                chatContainer.innerHTML = '';
                messageHistory = [];
            }

            async function sendMessage() {
                let userMessage = chatInput.value.trim();
                if (userMessage) {
                    if (!apiKey || !model) {
                        settingsError.textContent = 'Please enter API key and model in the settings panel.';
                        return;
                    }
                    
                    addMessage(userMessage, 'user');
                    
                    let currentMessageHistory = [];
                    
                    // Add system prompt if it's not empty
                    const systemPrompt = systemPromptInput.value.trim();
                    if (systemPrompt) {
                        currentMessageHistory.push({ role: "system", content: systemPrompt });
                    }
                    
                    // Add user message
                    currentMessageHistory.push({ role: "user", content: userMessage });
                    
                    // Add previous messages
                    currentMessageHistory = currentMessageHistory.concat(
                        messageHistory.map(msg => ({ role: msg.role, content: msg.rawContent }))
                    );

                    chatInput.value = '';

                    try {
                        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                            method: "POST",
                            headers: {
                                "Authorization": `Bearer ${apiKey}`,
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                "model": model,
                                "messages": currentMessageHistory,
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        let aiMessage = data.choices[0].message.content;
                        
                        addMessage(aiMessage, 'bot');
                    } catch (error) {
                        console.error('Error:', error);
                        settingsError.textContent = 'Error calling the API. Please check your settings and try again.';
                    }
                }
            }

            function addMessage(message, sender) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('chat-message');
                messageElement.classList.add(sender === 'user' ? 'user-message' : 'bot-message');

                const messageContent = document.createElement('div');
                messageContent.classList.add('message-content');

                const iconElement = document.createElement('div');
                iconElement.classList.add('message-icon');
                iconElement.textContent = sender === 'user' ? 'Human:' : 'AI:';

                const textElement = document.createElement('div');
                textElement.classList.add('message-text');
                
                const renderedMessage = renderMessageText(message);
                textElement.innerHTML = renderedMessage;

                messageContent.appendChild(iconElement);
                messageContent.appendChild(textElement);
                messageElement.appendChild(messageContent);

                chatContainer.appendChild(messageElement);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                messageHistory.push({
                    role: sender === 'user' ? 'user' : 'assistant',
                    rawContent: message,
                    renderedContent: renderedMessage
                });
            }

            function renderMessageText(message) {
                if (renderMode === 'text') {
                    // Preserve new lines and escape HTML
                    return escapeHtml(message).replace(/\n/g, '<br>');
                } else {
                    const markedOptions = {
                        breaks: true,
                        gfm: true
                    };

                    // Trim any trailing newlines before parsing
                    let trimmedMessage = message.replace(/\n+$/, '');
                    let renderedMessage = marked.parse(trimmedMessage, markedOptions);

                    // Remove trailing <br> and unnecessary <p> tags
                    renderedMessage = renderedMessage.replace(/<br\s*\/?>\s*$/, '').replace(/<\/p>\s*$/, '');

                    // Render KaTeX in the message
                    let tempDiv = document.createElement('div');
                    tempDiv.innerHTML = renderedMessage;
                    renderMathInElement(tempDiv, {
                        delimiters: [
                            {left: "$$", right: "$$", display: true},
                            {left: "$", right: "$", display: false},
                            {left: "\(", right: "\)", display: false},
                            {left: "\[", right: "\]", display: true},
                            {left: "\\(", right: "\\)", display: false},
                            {left: "\\[", right: "\\]", display: true}
                        ],
                        throwOnError: false
                    });
                    return tempDiv.innerHTML;
                }
            }

            function escapeHtml(unsafe) {
                return unsafe
                     .replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
            }

            function rerenderMessages() {
                chatContainer.innerHTML = ''; // Clear the chat container
                messageHistory.forEach((msg) => {
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('chat-message');
                    messageElement.classList.add(msg.role === 'user' ? 'user-message' : 'bot-message');

                    const messageContent = document.createElement('div');
                    messageContent.classList.add('message-content');

                    const iconElement = document.createElement('div');
                    iconElement.classList.add('message-icon');
                    iconElement.textContent = msg.role === 'user' ? 'Human:' : 'AI:';

                    const textElement = document.createElement('div');
                    textElement.classList.add('message-text');
                    
                    const renderedMessage = renderMessageText(msg.rawContent);
                    textElement.innerHTML = renderedMessage;

                    messageContent.appendChild(iconElement);
                    messageContent.appendChild(textElement);
                    messageElement.appendChild(messageContent);

                    chatContainer.appendChild(messageElement);
                });
            }
        });
    </script>
</body>
</html>
